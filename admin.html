<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Administração - SANSEI DECANTS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/feather-icons"></script>
    <style>
        body { font-family: 'Lato', sans-serif; }
        .text-gold-500 { color: #D4AF37; }
        .bg-gold-500 { background-color: #D4AF37; }
        .hover\:bg-gold-600:hover { background-color: #c09a58; }
        .ring-gold-500:focus { --tw-ring-color: #D4AF37; }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Auth Screen -->
    <div id="auth-screen" class="flex items-center justify-center min-h-screen">
        <div class="w-full max-w-md bg-white p-8 rounded-lg shadow-md">
            <h2 class="text-3xl font-bold text-center mb-6">Acesso Restrito</h2>
            <div id="auth-message" class="hidden mb-4 p-3 rounded-md text-center"></div>
            <form id="login-form">
                <div class="mb-4">
                    <label for="email" class="block text-sm font-semibold text-gray-700 mb-2">Email</label>
                    <input type="email" id="email" required class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 ring-gold-500">
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-sm font-semibold text-gray-700 mb-2">Senha</label>
                    <input type="password" id="password" required class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 ring-gold-500">
                </div>
                <button type="submit" class="w-full bg-gray-800 text-white font-bold py-3 rounded-md hover:bg-black transition-colors">Entrar</button>
            </form>
        </div>
    </div>

    <!-- Admin Panel (hidden by default) -->
    <div id="admin-panel" class="hidden">
        <header class="bg-white shadow-md">
            <div class="container mx-auto px-6 py-4 flex justify-between items-center">
                <h1 class="text-2xl font-bold text-gray-800">Painel de Administração</h1>
                <button id="logout-button" class="bg-red-500 text-white font-bold py-2 px-4 rounded-md hover:bg-red-600">Sair</button>
            </div>
        </header>
        <main class="container mx-auto p-6">
            <!-- Add Product Form -->
            <section id="add-product-section" class="bg-white p-8 rounded-lg shadow-md mb-8">
                <h2 class="text-2xl font-bold mb-6">Adicionar Novo Produto</h2>
                <form id="add-product-form">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="product-name" class="block text-sm font-semibold mb-2">Nome do Produto</label>
                            <input type="text" id="product-name" required class="w-full px-4 py-2 border rounded-md">
                        </div>
                        <div>
                            <label for="product-price" class="block text-sm font-semibold mb-2">Preço (ex: 89.90)</label>
                            <input type="number" step="0.01" id="product-price" required class="w-full px-4 py-2 border rounded-md">
                        </div>
                        <div>
                            <label for="product-category" class="block text-sm font-semibold mb-2">Categoria</label>
                            <select id="product-category" required class="w-full px-4 py-2 border rounded-md">
                                <option value="perfume">Perfume</option>
                                <option value="decant">Decant</option>
                            </select>
                        </div>
                        <div>
                            <label for="product-image" class="block text-sm font-semibold mb-2">URL da Imagem</label>
                            <input type="url" id="product-image" required class="w-full px-4 py-2 border rounded-md">
                        </div>
                        <div class="md:col-span-2">
                            <label for="product-description" class="block text-sm font-semibold mb-2">Descrição</label>
                            <textarea id="product-description" rows="4" required class="w-full px-4 py-2 border rounded-md"></textarea>
                        </div>
                    </div>
                    <div class="mt-6 text-right">
                        <button type="submit" class="bg-gold-500 text-black font-bold py-2 px-6 rounded-md hover:bg-gold-600">Adicionar Produto</button>
                    </div>
                </form>
            </section>

            <!-- Product List -->
            <section id="product-list-section" class="bg-white p-8 rounded-lg shadow-md">
                <h2 class="text-2xl font-bold mb-6">Lista de Produtos</h2>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="border-b">
                                <th class="py-2">Nome</th>
                                <th class="py-2">Categoria</th>
                                <th class="py-2">Preço</th>
                                <th class="py-2">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="product-list-body">
                            <!-- Products will be listed here -->
                        </tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.7/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.6.7/firebase-auth.js";
        import { getFirestore, collection, getDocs, addDoc, doc, deleteDoc, updateDoc, query, where } from "https://www.gstatic.com/firebasejs/9.6.7/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyC4-kp4wBq6fz-pG1Rm3VQcq6pO17OEeOI",
          authDomain: "sansei-d3cf6.firebaseapp.com",
          projectId: "sansei-d3cf6",
          storageBucket: "sansei-d3cf6.appspot.com",
          messagingSenderId: "774111823223",
          appId: "1:774111823223:web:c03c73c4b89d96244b8d72"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const authScreen = document.getElementById('auth-screen');
        const adminPanel = document.getElementById('admin-panel');
        const loginForm = document.getElementById('login-form');
        const logoutButton = document.getElementById('logout-button');
        const addProductForm = document.getElementById('add-product-form');
        const productListBody = document.getElementById('product-list-body');
        const authMessage = document.getElementById('auth-message');

        // Check auth state
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // For simplicity, we'll assume any logged-in user is an admin.
                // For production, you should use custom claims to verify admin status.
                authScreen.classList.add('hidden');
                adminPanel.classList.remove('hidden');
                await fetchAndRenderProducts();
            } else {
                authScreen.classList.remove('hidden');
                adminPanel.classList.add('hidden');
            }
            feather.replace();
        });

        // Login logic
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                // If login fails, try to register. This is for the first admin user.
                if (error.code === 'auth/user-not-found') {
                    try {
                        await createUserWithEmailAndPassword(auth, email, password);
                        showMessage('Conta de administrador criada com sucesso. Faça login agora.', 'green');
                    } catch (creationError) {
                        showMessage('Erro ao criar conta: ' + creationError.message, 'red');
                    }
                } else {
                    showMessage('Erro de login: ' + error.message, 'red');
                }
            }
        });

        // Logout logic
        logoutButton.addEventListener('click', async () => {
            await signOut(auth);
        });

        // Add product logic
        addProductForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const newProduct = {
                name: document.getElementById('product-name').value,
                price: parseFloat(document.getElementById('product-price').value),
                category: document.getElementById('product-category').value,
                image: document.getElementById('product-image').value,
                description: document.getElementById('product-description').value,
                rating: 0,
                reviews: []
            };

            try {
                await addDoc(collection(db, "products"), newProduct);
                addProductForm.reset();
                showMessage('Produto adicionado com sucesso!', 'green');
                await fetchAndRenderProducts();
            } catch (error) {
                console.error("Error adding document: ", error);
                showMessage('Erro ao adicionar produto.', 'red');
            }
        });

        // Fetch and render products
        async function fetchAndRenderProducts() {
            try {
                const querySnapshot = await getDocs(collection(db, "products"));
                productListBody.innerHTML = ''; // Clear list
                querySnapshot.forEach((doc) => {
                    const product = { id: doc.id, ...doc.data() };
                    const row = document.createElement('tr');
                    row.className = 'border-b';
                    row.innerHTML = `
                        <td class="py-2">${product.name}</td>
                        <td class="py-2 capitalize">${product.category}</td>
                        <td class="py-2">R$ ${product.price.toFixed(2)}</td>
                        <td class="py-2 flex gap-2">
                            <button class="delete-btn text-red-500 hover:text-red-700" data-id="${product.id}"><i data-feather="trash-2" class="w-5 h-5"></i></button>
                        </td>
                    `;
                    productListBody.appendChild(row);
                });
                feather.replace();
            } catch (error) {
                console.error("Error fetching products: ", error);
                showMessage('Erro ao carregar produtos.', 'red');
            }
        }

        // Handle delete
        productListBody.addEventListener('click', async (e) => {
            if (e.target.closest('.delete-btn')) {
                const button = e.target.closest('.delete-btn');
                const id = button.dataset.id;
                if (confirm('Tem a certeza que quer eliminar este produto?')) {
                    try {
                        await deleteDoc(doc(db, "products", id));
                        showMessage('Produto eliminado com sucesso.', 'green');
                        await fetchAndRenderProducts();
                    } catch (error) {
                        console.error("Error deleting document: ", error);
                        showMessage('Erro ao eliminar produto.', 'red');
                    }
                }
            }
        });
        
        function showMessage(message, color) {
            authMessage.textContent = message;
            authMessage.className = `mb-4 p-3 rounded-md text-center bg-${color}-100 text-${color}-700`;
        }

    </script>
</body>
</html>
